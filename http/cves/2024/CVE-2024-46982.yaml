id: cve-2024-46982-nextjs-pages-cache-poisoning

info:
  name: Next.js Pages SSR cache poisoning (CVE-2024-46982)
  author: BenraouaneSoufiane
  severity: high
  description: >
    Detects potentially cache-poisonable SSR pages (Pages Router) where a crafted
    request can elicit shared-cache / staleness signals (e.g. X-Nextjs-Cache: STALE
    or Cache-Control: s-maxage=1, stale-while-revalidate) while the page is rendered
    via getServerSideProps (fingerprinted by "__N_SSP": true or "gssp": true in __NEXT_DATA__).
  tags: cve,cache,poisoning,nextjs,ssr,vercel,web
  reference:
    - https://nextjs.org
  metadata:
    cve: CVE-2024-46982
    framework: nextjs
    router: pages

http:
  - method: GET
    path:
      - "{{BaseURL}}/"
      - "{{BaseURL}}/home"
      - "{{BaseURL}}/dashboard"
      - "{{BaseURL}}/account"
      - "{{BaseURL}}/settings"
      - "{{BaseURL}}/profile"
      - "{{BaseURL}}/admin"

    headers:
      x-now-route-matches: "1"

    max-redirects: 1
    stop-at-first-match: true

    matchers:
      - type: dsl
        name: combined-indicator
        dsl:
          - |
            status_code == 200 &&
            (
              contains(to_lower(all_headers), 'x-nextjs-cache: stale') ||
              contains(to_lower(all_headers), 'cache-control: s-maxage=1, stale-while-revalidate')
            ) &&
            regex('(\"(__N_SSP|gssp)\"\\s*:\\s*true)', body)
